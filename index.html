<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osho Tapoban - Entry System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #qr-reader {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: visibility 0.5s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .operator-tab.active {
            border-color: #f97316;
            color: #f97316;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6 hidden">
        
        <header class="text-center">
             <h1 id="app-title" class="text-2xl md:text-3xl font-bold text-orange-600">Osho Tapoban</h1>
             <p id="app-subtitle" class="text-gray-500">Digital Entry Pass</p>
        </header>

        <!-- Visitor View -->
        <div id="visitor-view" class="hidden">
            <div id="ticket-form-section">
                <form id="ticket-form" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                        <input type="tel" id="phone" name="phone" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div class="pt-2">
                         <button type="submit" id="purchase-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-all duration-300 transform hover:scale-105 shadow-md">
                            Get Your Ticket
                        </button>
                    </div>
                </form>
            </div>
            <div id="ticket-display-section" class="hidden text-center space-y-4">
                 <h2 class="text-xl font-bold text-green-600">Your Ticket is Ready!</h2>
                <div id="qrcode" class="flex justify-center p-4 bg-gray-50 rounded-lg"></div>
                <div class="text-left bg-orange-50 p-4 rounded-lg border border-orange-200">
                    <p><strong>Name:</strong> <span id="ticket-name"></span></p>
                    <p><strong>Date:</strong> <span id="ticket-date"></span></p>
                    <p><strong>Status:</strong> <span id="ticket-status" class="font-semibold"></span></p>
                </div>
                <p class="text-gray-500 text-sm">Show this QR code to the guard at the entrance.</p>
                 <button id="new-ticket-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-300">
                    Get Another Ticket
                </button>
            </div>
             <div id="pending-payment-section" class="hidden text-center space-y-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-xl font-bold text-blue-600">Payment Pending</h2>
                <p>Please show this screen to the operator and pay with cash to activate your ticket.</p>
                <p class="font-mono text-gray-700 bg-gray-200 px-2 py-1 rounded">Your ID: <strong id="pending-ticket-id"></strong></p>
             </div>
        </div>

        <!-- Operator View -->
        <div id="operator-view" class="hidden">
            <!-- Operator Tabs -->
            <div class="flex border-b">
                <button id="pending-tab-btn" class="operator-tab flex-1 py-2 text-center font-semibold border-b-2">Ожидают оплаты</button>
                <button id="stats-tab-btn" class="operator-tab flex-1 py-2 text-center font-semibold border-b-2">Статистика</button>
            </div>

            <!-- Pending Payments Section -->
            <div id="operator-pending-section" class="mt-4">
                <div id="pending-list" class="space-y-3 max-h-80 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                    <p id="no-pending-msg" class="text-gray-500 text-center py-4">Нет ожидающих платежей.</p>
                </div>
            </div>

            <!-- Statistics Section -->
            <div id="operator-stats-section" class="hidden mt-4 space-y-4">
                <div>
                    <label for="stats-date" class="block text-sm font-medium text-gray-700">Выберите дату:</label>
                    <input type="date" id="stats-date" name="stats-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-bold text-orange-700">Всего посетителей: <span id="stats-total-count">0</span></h3>
                </div>
                <div id="stats-visitor-list" class="space-y-3 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                     <p id="no-visitors-msg" class="text-gray-500 text-center py-4">Нет данных за этот день.</p>
                </div>
            </div>
        </div>


        <!-- Guard View -->
        <div id="guard-view" class="hidden">
            <div id="guard-scanner-section" class="space-y-4">
                 <button id="start-scan-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105">
                    Start Camera Scan
                </button>
                <div id="qr-reader-container" class="hidden">
                    <div id="qr-reader" class="bg-gray-200"></div>
                </div>
            </div>
            <div id="scan-result" class="mt-4 text-center"></div>
        </div>
         
         <!-- App Info for Sharing -->
        <div class="text-center pt-4 border-t border-gray-200">
            <p class="text-xs text-gray-400">Your User ID (for collaboration):</p>
            <p id="user-id-display" class="text-xs text-gray-500 font-mono break-all"></p>
        </div>
    </div>
    
     <div id="loading-spinner" class="text-center">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2 text-gray-600">Loading...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Встроенные библиотеки для QR-кодов -->
    <script>
        // --- Library: qrcode.min.js ---
        var QRCode;(function(){function r(t,e){if(t.m[e])return t.m[e].exports;var n=t.m[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,r),n.l=!0,n.exports}var o,l,s;s=this,l={VERSION:"1.4.4",CorrectLevel:{L:1,M:0,Q:3,H:2},},o=function(){var t={};t.PAD0=236,t.PAD1=17;var i=function(){function t(t,e){if(void 0===t||null===t)throw new Error("The QRCode may be null or undefined");if(void 0===e||null===e)throw new Error("The Text may be null or undefined");var n={},i=!1,r=null,o=null,s=null,l=null;n.make=function(){r=new u(f.getTypeNumber(e,o),o),s=new a(e,r.getRightType()),l=new h;for(var t=0;t<r.getModuleCount();t++)for(var n=0;n<r.getModuleCount();n++)l.isDark(t,n)?i.drawImage(t,n):i.drawLight(t,n);i.drawFinderPattern(0,0),i.drawFinderPattern(r.getModuleCount()-7,0),i.drawFinderPattern(0,r.getModuleCount()-7),i.drawAlignmentPattern(),i.drawTimingPattern(),i.drawFormatInfo(s.getRightFormat()),r.isLast()&&i.drawLastInfo(r.getTypeNumber(),s.getRightFormat()),i.drawVersion(r.getRightType()),i.drawFunctionPattern()},n.makeImage=function(){i=new d(r.getModuleCount(),r.getModuleCount())},n.makeSVG=function(t){i=new m(r.getModuleCount(),r.getModuleCount(),t)},n.makeTable=function(){i=new c(r.getModuleCount(),r.getModuleCount())},n.getDataURL=function(t,e){return i.getDataURL(t,e)},n.getSVG=function(){return i.getSVG()},n.getSVGXML=function(){return i.getSVGXML()},n.getElement=function(){return i.getElement()},n.getTable=function(){return i.getTable()},n.getASCII=function(t){return i.getASCII(t)},n.render=function(){i.render()},n.clear=function(){i.clear()},n.getMatrix=function(){return l.getMatrix()};var f=new p,u=function(){var i=null,e=null,n=null,r=null,o=null,s=null,l=null,h=null;return i=function(t,e){var n=c(t,e);this.getRightType=function(){return n},this.getRightErrorCorrectLevel=function(){return e},this.isLast=function(){return!0},this.getTypeNumber=function(){return t}},i.prototype.getModuleCount=function(){return this.getTypeNumber()*4+17},e=function(t,e){var n=u(t,e);this.getRightType=function(){return n},this.getRightErrorCorrectLevel=function(){return e},this.isLast=function(){return!1},this.getTypeNumber=function(){return t}},n=function(t,e){var n=f(t,e);this.getRightType=function(){return n},this.getRightErrorCorrectLevel=function(){return e},this.isLast=function(){return!1},this.getTypeNumber=function(){return t}},r={Patterns:[[6,26],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]]},o=function(t){return[t.getBCHTypeInfo(1),t.getBCHTypeInfo(2),t.getBCHTypeInfo(3),t.getBCHTypeInfo(4),t.getBCHTypeInfo(5),t.getBCHTypeInfo(6),t.getBCHTypeInfo(7),t.getBCHTypeInfo(8),t.getBCHTypeInfo(9),t.getBCHTypeInfo(10),t.getBCHTypeInfo(11),t.getBCHTypeInfo(12),t.getBCHTypeInfo(13),t.getBCHTypeInfo(14),t.getBCHTypeInfo(15),t.getBCHTypeInfo(16),t.getBCHTypeInfo(17),t.getBCHTypeInfo(18)]},s={G15:1335,G18:7973,G15_MASK:21522},l=function(i,e){return s.G15<<10|i<<5|e},h=function(t,e){var n=g.getLostPoint(t);return e<n&&(t.addData(i.PAD0,8),e=t.getLengthInBits()),t.addData(i.PAD1,8),t},new i(t,o)},a=function(t,i){function e(t){var e=function(t){for(var e=0,n=0,r=0;r<t.length;r++){var o=t[r];if(o>=97&&o<=122)o-=32;else if(o>=65&&o<=90);else{e=1;break}n+=o}return 0===e?n%45:e}(t);return 0===e?0:1===e?1:void 0}var r,o,s,l;if("string"==typeof t)o=e(t);else{if("object"==typeof t&&t.data)switch(t.mode){case a.MODE_NUMBER:o=a.MODE_NUMBER;break;case a.MODE_ALPHA_NUM:o=a.MODE_ALPHA_NUM;break;case a.MODE_8BIT_BYTE:o=a.MODE_8BIT_BYTE;break;default:throw new Error("Incorrect ZPL mode '"+t.mode+"'")}t=t.data}switch(o){case a.MODE_NUMBER:s=new c(t,i.getRightType(),i.getRightErrorCorrectLevel());break;case a.MODE_ALPHA_NUM:s=new f(t,i.getRightType(),i.getRightErrorCorrectLevel());break;case a.MODE_8BIT_BYTE:s=new u(t,i.getRightType(),i.getRightErrorCorrectLevel());break;default:throw new Error("Incorrect ZPL mode")}r=new p(s.getRightData(),i),l=new h(r.getRightPaddedData(),i),this.getRightFormat=function(){return l.getRightFormat()},this.getRightData=function(){return l.getRightData()}};a.MODE_NUMBER=0,a.MODE_ALPHA_NUM=1,a.MODE_8BIT_BYTE=2;var h=function(i,e){function n(t,e,n){for(var r=0,o=0;o<n.length;o++)r+=parseInt(n[o],2);for(var s=0,l=0;l<e.length;l++)s+=parseInt(e[l],2);var a=parseInt(t,2);return(a+r+s)%255==0}function r(t,e){return t.slice(0,e)}var o,s;if(s=a.getBlocks(i.length,e)){var l=a.getRSBlocks(e);o=new u(s,l,e);var h=o.getData(),p=o.getErrorCorrectPolynomial();this.getRightData=function(){return h},this.getRightFormat=function(){return p}}else{var f=new d(i,e),g=f.getData(),m=f.getFormatInfo();this.getRightData=function(){return g},this.getRightFormat=function(){return m}}};if("string"==typeof e)n.make();else if("object"==typeof e)for(var g in o=e.correctLevel||QRCode.CorrectLevel.H,e)n[g]=function(t){return function(){var i={};for(var r in e)i[r]=e[r];i[g]=t,new QRCode(t,i)}}(e[g]);return n}},p=function(){function t(t,e){if(void 0===t.length)throw new Error(t.length+"/"+e);for(var n=0;n<t.length&&0==t[n];)n++;this.num=new Array(t.length-n+e);for(var r=0;r<t.length-n;r++)this.num[r]=t[r+n]}return t.prototype.get=function(t){return this.num[t]},t.prototype.getLength=function(){return this.num.length},t.prototype.multiply=function(t){for(var e=new Array(this.getLength()+t.getLength()-1),n=0;n<this.getLength();n++)for(var r=0;r<t.getLength();r++)e[n+r]^=o.gexp(o.glog(this.get(n))+o.glog(t.get(r)));return new i(e,0)},t.prototype.mod=function(t){if(this.getLength()-t.getLength()<0)return this;for(var e=o.glog(this.get(0))-o.glog(t.get(0)),n=new Array(this.getLength()),r=0;r<this.getLength();r++)n[r]=this.get(r);for(r=0;r<t.getLength();r++)n[r]^=o.gexp(o.glog(t.get(r))+e);return new i(n,0).mod(t)},t},u=function(){return function(t,e){this.type=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}},a=function(){return function(t,e){if(void 0===t||null===t)throw new Error("The QRCode may be null or undefined");if(void 0===e||null===e)throw new Error("The Text may be null or undefined");this.options=e;var n=new o(this.options.type,this.options.correctLevel);n.addData(t),n.make(),this.text=t,this.qrcode=n}},h=function(){function t(){}return t.prototype.getBCHTypeInfo=function(t){for(var e=t<<10;i(e)-i(r)>=0;)e^=r<<i(e)-i(r);return(t<<10|e)^o},t.prototype.getBCHTypeNumber=function(t){for(var e=t<<12;i(e)-i(n)>=0;)e^=n<<i(e)-i(n);return t<<12|e},t.prototype.getPatternPosition=function(t){return e[t-1]},t.prototype.getMaskFunction=function(t){switch(t){case s.PATTERN000:return function(t,e){return(t+e)%2==0};case s.PATTERN001:return function(t,e){return t%2==0};case s.PATTERN010:return function(t,e){return e%3==0};case s.PATTERN011:return function(t,e){return(t+e)%3==0};case s.PATTERN100:return function(t,e){return(Math.floor(t/2)+Math.floor(e/3))%2==0};case s.PATTERN101:return function(t,e){return t*e%2+t*e%3==0};case s.PATTERN110:return function(t,e){return(t*e%2+t*e%3)%2==0};case s.PATTERN111:return function(t,e){return(t*e%3+(t+e)%2)%2==0};default:throw new Error("bad maskPattern:"+t)}},t.prototype.getErrorCorrectPolynomial=function(t){for(var e=new i([1],0),n=0;n<t;n++)e=e.multiply(new i([1,o.gexp(n)],0));return e},t.prototype.getLengthInBits=function(t,e){if(1<=e&&e<10)switch(t){case l.MODE_NUMBER:return 10;case l.MODE_ALPHA_NUM:return 9;case l.MODE_8BIT_BYTE:return 8;case l.MODE_KANJI:return 8;default:throw new Error("mode:"+t)}else if(e<27)switch(t){case l.MODE_NUMBER:return 12;case l.MODE_ALPHA_NUM:return 11;case l.MODE_8BIT_BYTE:return 16;case l.MODE_KANJI:return 10;default:throw new Error("mode:"+t)}else{if(!(e<41))throw new Error("type:"+e);switch(t){case l.MODE_NUMBER:return 14;case l.MODE_ALPHA_NUM:return 13;case l.MODE_8BIT_BYTE:return 16;case l.MODE_KANJI:return 12;default:throw new Error("mode:"+t)}}},t.prototype.getLostPoint=function(t){for(var e=t.getModuleCount(),n=0,r=0;r<e;r++)for(var i=0;i<e;i++){for(var o=0,s=t.isDark(r,i),l=-1;l<=1;l++)if(!(r+l<0||e<=r+l))for(var a=-1;a<=1;a++)i+a<0||e<=i+a||0==l&&0==a||s==t.isDark(r+l,i+a)&&o++;o>5&&(n+=3+o-5)}for(r=0;r<e-1;r++)for(i=0;i<e-1;i++){var h=0;t.isDark(r,i)&&h++,t.isDark(r+1,i)&&h++,t.isDark(r,i+1)&&h++,t.isDark(r+1,i+1)&&h++,(0==h||4==h)&&(n+=3)}for(r=0;r<e;r++)for(i=0;i<e-6;i++)t.isDark(r,i)&&!t.isDark(r,i+1)&&t.isDark(r,i+2)&&t.isDark(r,i+3)&&t.isDark(r,i+4)&&!t.isDark(r,i+5)&&t.isDark(r,i+6)&&(n+=40);for(i=0;i<e;i++)for(r=0;r<e-6;r++)t.isDark(r,i)&&!t.isDark(r+1,i)&&t.isDark(r+2,i)&&t.isDark(r+3,i)&&t.isDark(r+4,i)&&!t.isDark(r+5,i)&&t.isDark(r+6,i)&&(n+=40);for(var u=0,i=0;i<e;i++)for(r=0;r<e;r++)t.isDark(r,i)&&u++;return n+=Math.abs(100*u/e/e-50)/5*10},t}(),f=function(){function t(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.moduleCount=t*4+17,this.modules=new Array(this.moduleCount),this.dataCache=null,this.dataList=new Array;for(var n=0;n<this.moduleCount;n++){this.modules[n]=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++)this.modules[n][r]=null}this.initDataCache()}return t.prototype.initDataCache=function(){this.dataCache=new Array(this.moduleCount*this.moduleCount);for(var t=0;t<this.moduleCount*this.moduleCount;t++)this.dataCache[t]=null},t.prototype.isDark=function(t,e){return null!=this.modules[t][e]?this.modules[t][e]:!1},t.prototype.getModuleCount=function(){return this.moduleCount},t.prototype.make=function(){this.makeImpl(!1,this.getBestMaskPattern())},t.prototype.makeImpl=function(t,e){this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(t,e),7>=this.typeNumber&&this.setupTypeNumber(t),null==this.dataCache&&this.mapData(this.dataList,e)},t.prototype.setupPositionProbePattern=function(t,e){for(var n=t-3;n<=t+3;n++)for(var r=e-3;r<=e+3;r++)n>=0&&this.moduleCount>n&&r>=0&&this.moduleCount>r&&(this.modules[n][r]=n>=t-2&&t+2>=n&&r>=e-2&&e+2>=r||n>=t-1&&t+1>=n&&r>=e-1&&e+1>=r?!0:!1)},t.prototype.getBestMaskPattern=function(){for(var t=0,e=0,n=0;n<8;n++){this.makeImpl(!0,n);var r=i.getLostPoint(this);(0==n||t>r)&&(t=r,e=n)}return e},t.prototype.createMovieClip=function(t,e,n){var r=t.createEmptyMovieClip(e,n),i=1;this.make();for(var o=0;o<this.modules.length;o++)for(var s=o*this.moduleSize,l=0;l<this.modules[o].length;l++){var a=l*this.moduleSize,h=this.modules[o][l];h&&(r.beginFill(0,100),r.moveTo(a,s),r.lineTo(a+this.moduleSize,s),r.lineTo(a+this.moduleSize,s+this.moduleSize),r.lineTo(a,s+this.moduleSize),r.endFill())}return r},t.prototype.setupTimingPattern=function(){for(var t=8;t<this.moduleCount-8;t++)null==this.modules[t][6]&&(this.modules[t][6]=t%2==0);for(var e=8;e<this.moduleCount-8;e++)null==this.modules[6][e]&&(this.modules[6][e]=e%2==0)},t.prototype.setupPositionAdjustPattern=function(){for(var t=i.getPatternPosition(this.typeNumber),e=0;e<t.length;e++)for(var n=0;n<t.length;n++){var r=t[e],o=t[n];if(null==this.modules[r][o])for(var s=r-2;s<=r+2;s++)for(var l=o-2;l<=o+2;l++)s==r-2||s==r+2||l==o-2||l==o+2||s==r&&l==o?this.modules[s][l]=!0:this.modules[s][l]=!1}},t.prototype.setupTypeNumber=function(t){for(var e=i.getBCHTypeNumber(this.typeNumber),n=0;n<18;n++){var r=!t&&1==(e>>n&1);this.modules[Math.floor(n/3)][n%3+this.moduleCount-8-3]=r}for(n=0;n<18;n++){r=!t&&1==(e>>n&1);this.modules[n%3+this.moduleCount-8-3][Math.floor(n/3)]=r}},t.prototype.setupTypeInfo=function(t,e){for(var n=i.getBCHTypeInfo(this.errorCorrectLevel<<3|e),r=0;r<15;r++){var o=!t&&1==(n>>r&1);r<6?this.modules[r][8]=o:r<8?this.modules[r+1][8]=o:this.modules[this.moduleCount-15+r][8]=o}for(r=0;r<15;r++){o=!t&&1==(n>>r&1);r<8?this.modules[8][this.moduleCount-r-1]=o:r<9?this.modules[8][15-r-1+1]=o:this.modules[8][15-r-1]=o}this.modules[this.moduleCount-8][8]=!t},t.prototype.mapData=function(t,e){for(var n=-1,r=this.moduleCount-1,o=7,s=0,l=this.moduleCount-1;l>0;l-=2)for(6==l&&l--;;){for(var a=0;a<2;a++)if(null==this.modules[r][l-a]){var h=!1;s<t.length&&(h=1==(t[s]>>>o&1)),i.getMaskFunction(e)(r,l-a)&&(h=!h),this.modules[r][l-a]=h,-1==(o-=1)&&(s++,o=7)}if((r+=n)<0||this.moduleCount<=r){r-=n,n=-n;break}}},t.addData=function(e,n){switch(n=n||l.MODE_8BIT_BYTE,this.dataList.push(new r(n,e)),this.dataCache=null,n){case l.MODE_NUMBER:this.addDataNumber(e);break;case l.MODE_ALPHA_NUM:this.addDataAlphaNum(e);break;case l.MODE_8BIT_BYTE:this.addData8bitByte(e);break;case l.MODE_KANJI:this.addDataKanji(e);break;default:throw new Error("mode:"+n)}},t.prototype.addDataNumber=function(t){for(var e=0;e<t.length;e+=3){var n=t.substr(e,3);this.addData(parseInt(n),this.getLength(l.MODE_NUMBER))}},t.prototype.addDataAlphaNum=function(t){for(var e=0;e<t.length;e+=2){var n=o.toCharCode(t.charAt(e))*45+o.toCharCode(t.charAt(e+1));this.addData(n,11)}},t.prototype.addData8bitByte=function(t){for(var e=0;e<t.length;e++)this.addData(t.charCodeAt(e),8)},t.prototype.addDataKanji=function(t){for(var e=0;e<t.length;e+=2){var n=((255&t.charCodeAt(e))<<8|255&t.charCodeAt(e+1))-33088;this.addData(n,13)}},t.prototype.get=function(t){var e=Math.floor(t/8);return 1==(this.dataList[e].data>>7-t%8&1)},t.prototype.getLength=function(){for(var t=0,e=0;e<this.dataList.length;e++)t+=this.dataList[e].length;return t},t.prototype.getRightType=function(t){return this.typeNumber},t.prototype.getRightErrorCorrectLevel=function(t){return this.errorCorrectLevel},t.prototype.getModuleSize=function(){return this.moduleSize},t},g=function(t,e){this._el=t,this._htOption=e};g.prototype.draw=function(t){var e=this._htOption,n=this._el,r=t.getModuleCount();Math.floor(e.width/r)>2*Math.floor(e.height/r)?e.width=e.height*r:Math.floor(e.height/r)>2*Math.floor(e.width/r)&&(e.height=e.width*r);var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var o=i.getContext("2d"),s=e.width/r,l=e.height/r,a=Math.round(s),h=Math.round(l);if(e.colorDark=e.colorDark||"#000000",e.colorLight=e.colorLight||"#ffffff",e.drawer="canvas",o.fillStyle=e.colorLight,o.fillRect(0,0,e.width,e.height),e._android&&(a=s,h=l),a>0&&h>0)for(var u=0;u<r;u++)for(var f=0;f<r;f++)if(t.isDark(u,f)){o.fillStyle=e.colorDark;var p=f*s,c=u*l;o.fillRect(p,c,s,l)}if(e.logo){var d=new Image;d.src=e.logo,d.onload=function(){var t,s,l,a,h=d.width,u=d.height,f=e.width,p=e.height;l=h>f?.7*f:h,a=u>p?.7*p:u,t=(f-l)/2,s=(p-a)/2,o.drawImage(d,t,s,l,a)},d.onerror=function(t){console.error(t)}}n.appendChild(i)},g.prototype.clear=function(){var t=this._el.getContext("2d");t.clearRect(0,0,this._el.width,this._el.height)},o=window.QRCode,QRCode=i,QRCode.CorrectLevel=l,QRCode.QRCode=a,QRCode.QRError=p,QRCode.QRNumber=c,QRCode.QRAlphaNum=f,QRCode.QR8bitByte=u,QRCode.QRKanji=d,QRCode.QRSegment=r,QRCode.Util={glog:function(t){if(t<1)throw new Error("glog("+t+")");return a[t]},gexp:function(t){for(;t<0;)t+=255;for(;t>=256;)t-=255;return h[t]},getBCHTypeInfo:function(t){for(var e=t<<10;s(e)-s(l.G15)>=0;)e^=l.G15<<s(e)-s(l.G15);return(t<<10|e)^l.G15_MASK},getBCHTypeNumber:function(t){for(var e=t<<12;s(e)-s(l.G18)>=0;)e^=l.G18<<s(e)-s(l.G18);return t<<12|e},getPatternPosition:function(t){return u[t-1]},getMaskFunction:function(t){return e[t]},getErrorCorrectPolynomial:function(t){for(var e=new p([1],0),n=0;n<t;n++)e=e.multiply(new p([1,this.gexp(n)],0));return e},getLengthInBits:function(t,e){if(1<=e&&e<10)switch(t){case c.MODE_NUMBER:return 10;case f.MODE_ALPHA_NUM:return 9;case u.MODE_8BIT_BYTE:return 8;case d.MODE_KANJI:return 8;default:throw new Error("mode:"+t)}else if(e<27)switch(t){case c.MODE_NUMBER:return 12;case f.MODE_ALPHA_NUM:return 11;case u.MODE_8BIT_BYTE:return 16;case d.MODE_KANJI:return 10;default:throw new Error("mode:"+t)}else{if(!(e<41))throw new Error("type:"+e);switch(t){case c.MODE_NUMBER:return 14;case f.MODE_ALPHA_NUM:return 13;case u.MODE_8BIT_BYTE:return 16;case d.MODE_KANJI:return 12;default:throw new Error("mode:"+t)}}},getLostPoint:function(t){for(var e=t.getModuleCount(),n=0,r=0;r<e;r++)for(var i=0;i<e;i++){for(var o=0,s=t.isDark(r,i),l=-1;l<=1;l++)if(!(r+l<0||e<=r+l))for(var a=-1;a<=1;a++)i+a<0||e<=i+a||0==l&&0==a||s==t.isDark(r+l,i+a)&&o++;o>5&&(n+=3+o-5)}for(r=0;r<e-1;r++)for(i=0;i<e-1;i++){var h=0;t.isDark(r,i)&&h++,t.isDark(r+1,i)&&h++,t.isDark(r,i+1)&&h++,t.isDark(r+1,i+1)&&h++,(0==h||4==h)&&(n+=3)}for(r=0;r<e;r++)for(i=0;i<e-6;i++)t.isDark(r,i)&&!t.isDark(r,i+1)&&t.isDark(r,i+2)&&t.isDark(r,i+3)&&t.isDark(r,i+4)&&!t.isDark(r,i+5)&&t.isDark(r,i+6)&&(n+=40);for(i=0;i<e;i++)for(r=0;r<e-6;r++)t.isDark(r,i)&&!t.isDark(r+1,i)&&t.isDark(r+2,i)&&t.isDark(r+3,i)&&t.isDark(r+4,i)&&!t.isDark(r+5,i)&&t.isDark(r+6,i)&&(n+=40);for(var f=0,i=0;i<e;i++)for(r=0;r<e;r++)t.isDark(r,i)&&f++;return n+=Math.abs(100*f/e/e-50)/5*10}},QRCode.noConflict=function(){var t=window.QRCode;return window.QRCode=o,t},"function"==typeof define&&define.amd?define([],function(){return QRCode}):"object"==typeof module&&module.exports&&(module.exports=QRCode)})();

        // --- Library: html5-qrcode.min.js ---
        !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Html5Qrcode={})}(this,(function(t){"use strict";var e,n;!function(t){t.L="L",t.M="M",t.Q="Q",t.H="H"}(e||(e={})),function(t){t.Reader="Reader",t.Writer="Writer"}(n||(n={}));var r=function(){function t(t,e){this.message=t,this.name=e||n.Reader}return t.prototype.toString=function(){return this.name+": "+this.message},t}();var i=function(t,e){this.message=t,this.name=e||n.Writer},o={code:2,message:"QR code parse error, error = "},s={code:3,message:"Error getting user media, error = "},a={code:4,message:"User media not available"},c={code:5,message:"Could not get user media as no camera found"},l={code:6,message:"Unable to query supported devices, error = "},h={code:7,message:"No camera found"},u={code:8,message:"NotAllowedError, error = "},d={code:9,message:"NotFoundError, error = "},p={code:10,message:"NotReadableError, error = "},f={code:11,message:"OverconstrainedError, error = "},m={code:12,message:"StreamApiNotSupportedError, error = "},g={code:13,message:"InsecureContextError, error = "},v={code:14,message:"Frame Grabber not initialized"},y={code:1,message:"Not implemented"},Q=function(){function t(){}return t.create=function(e){var n;switch(e.code){case 2:n=o;break;case 3:n=s;break;case 4:n=a;break;case 5:n=c;break;case 6:n=l;break;case 7:n=h;break;case 8:n=u;break;case 9:n=d;break;case 10:n=p;break;case 11:n=f;break;case 12:n=m;break;case 13:n=g;break;case 14:n=v;break;case 1:n=y;break;default:throw"Invalid error code"}var i=new r(n.message+e.message);return i.name=""+n.code,i},t}();function b(t){var e=document.getElementById(t);if(!e)throw new r("HTML Element with id="+t+" not found");return e}var w={facingMode:"environment",focusMode:"continuous",zoom:1};function _(t){var e,n,r,i,o=w;return t?((e=t.facingMode)?o.facingMode=e:t.advanced&&t.advanced.length&&t.advanced.forEach((function(t){t.facingMode&&(o.facingMode=t.facingMode)})),(n=t.focusMode)?o.focusMode=n:t.advanced&&t.advanced.length&&t.advanced.forEach((function(t){t.focusMode&&(o.focusMode=t.focusMode)})),(r=t.zoom)?o.zoom=r:t.advanced&&t.advanced.length&&t.advanced.forEach((function(t){t.zoom&&(o.zoom=t.zoom)})),o):(i=function(t){t.facingMode="environment"}(o),o)}function C(t){return{aspectRatio:t?t.aspectRatio:void 0,disableFlip:t?t.disableFlip:!1,qrbox:t?t.qrbox:void 0,videoConstraints:t?t.videoConstraints:void 0}}var R,E=function(){function t(t){this.disableFlip=!1,this.shouldScan=t.shouldScan||!0,this.qrCodeSuccessCallback=t.qrCodeSuccessCallback,this.qrCodeErrorCallback=t.qrCodeErrorCallback||function(t){},this.preferredCameraDevice=t.preferredCameraDevice}return t.prototype.setScanning=function(t){this.shouldScan=t},t.prototype.render=function(t,e){this.videoElement=document.createElement("video"),this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.autoplay=!0,this.videoElement.playsInline=!0,this.disableFlip||(this.videoElement.style.transform="scaleX(-1)"),this.localMediaStream=e,this.videoElement.srcObject=e,t.appendChild(this.videoElement),this.scan()},t.prototype.scan=function(t){var e=this;t&&(this.preferredCameraDevice=t);var n=new Worker(E.ASSETS.DECODER);n.onmessage=function(t){if(t.data.type&&"QR_CODE_RESULT"===t.data.type){var r={decodedText:t.data.data,result:{format:{format:zxing.BarcodeFormat.QR_CODE,formatName:"QR_CODE"},text:t.data.data,rawBytes:new Uint8Array(0),numBits:0,resultPoints:[],timestamp:Date.now()}};e.qrCodeSuccessCallback(t.data.data,r)}else"Error"===t.data.type&&"QR_CODE_RESULT"===t.data.error&&e.qrCodeErrorCallback("QR code parse error, error = "+t.data.message)};var r=this.videoElement.getContext("2d");if(this.localMediaStream){var i=function(){if(e.shouldScan){var t=e.videoElement.videoWidth,o=e.videoElement.videoHeight;r.drawImage(e.videoElement,0,0,t,o);var s=r.getImageData(0,0,t,o);n.postMessage({type:"decode",data:s})}setTimeout(i,100)};setTimeout(i,100)}},t.prototype.stop=function(){this.shouldScan=!1;for(var t=0;t<this.localMediaStream.getTracks().length;t++)this.localMediaStream.getTracks()[t].stop();this.videoElement.remove()},t}();E.ASSETS={DECODER:"./decoder.js"},function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.AZTEC=1]="AZTEC",t[t.CODABAR=2]="CODABAR",t[t.CODE_39=3]="CODE_39",t[t.CODE_93=4]="CODE_93",t[t.CODE_128=5]="CODE_128",t[t.DATA_MATRIX=6]="DATA_MATRIX",t[t.EAN_8=7]="EAN_8",t[t.EAN_13=8]="EAN_13",t[t.ITF=9]="ITF",t[t.MAXICODE=10]="MAXICODE",t[t.PDF_417=11]="PDF_417",t[t.QR_CODE=12]="QR_CODE",t[t.RSS_14=13]="RSS_14",t[t.RSS_EXPANDED=14]="RSS_EXPANDED",t[t.UPC_A=15]="UPC_A",t[t.UPC_E=16]="UPC_E",t[t.UPC_EAN_EXTENSION=17]="UPC_EAN_EXTENSION",t[t.MSI=18]="MSI",t[t.PLESSEY=19]="PLESSEY"}(R||(R={}));var S=function(){function t(t,e){this.decodedText=t,this.result=e}return t}();function A(t,e,n){if(!t.videoConstraints)return e;var r,i,o,s,a={};return t.videoConstraints.facingMode&&!t.videoConstraints.deviceId?(r="exact",i="facingMode","string"==typeof t.videoConstraints.facingMode?o=t.videoConstraints.facingMode:"object"==typeof t.videoConstraints.facingMode&&t.videoConstraints.facingMode.exact?o=t.videoConstraints.facingMode.exact:(r="ideal","string"==typeof t.videoConstraints.facingMode?o=t.videoConstraints.facingMode:o=t.videoConstraints.facingMode.ideal),s={},s[r]=o,a.facingMode=s):t.videoConstraints.deviceId&&!t.videoConstraints.facingMode?(r="exact",i="deviceId","string"==typeof t.videoConstraints.deviceId?o=t.videoConstraints.deviceId:"object"==typeof t.videoConstraints.deviceId&&t.videoConstraints.deviceId.exact?o=t.videoConstraints.deviceId.exact:(r="ideal","string"==typeof t.videoConstraints.deviceId?o=t.videoConstraints.deviceId:o=t.videoConstraints.deviceId.ideal),s={},s[r]=o,a.deviceId=s):t.videoConstraints.facingMode||t.videoConstraints.deviceId?n?a=function(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return!0;return!1}(e,t.videoConstraints)?t.videoConstraints:e:(t.videoConstraints.facingMode&&console.error("`facingMode` will be ignored as `videoConstraints` has been provided."),t.videoConstraints.deviceId&&console.error("`deviceId` will be ignored as `videoConstraints` has been provided."),e):e}function T(t){return!!t&&("environment"===t||t.exact&&"environment"===t.exact||t.ideal&&"environment"===t.ideal)}var I=function(){function t(t){this.element=t}return t.prototype.getShadedRegionBounds=function(t,e){if(t>e)throw"'width' > 'height'";var n={x:0,y:0,width:0,height:0,downscaledWidth:0,downscaledHeight:0};return n.width=n.height="number"==typeof this.element.qrbox?this.element.qrbox:this.element.qrbox(t,e).width,n.width>t&&(console.warn("Shaded region width cannot be larger than the video feed width. Shading will be ignored"),n.width=t),n.height=n.width,n.x=(t-n.width)/2,n.y=(e-n.height)/2,n.downscaledWidth=n.width,n.downscaledHeight=n.height,n}return t}();var O,L,P,M,k,D,x,F=function(t,e){var n=document.getElementById(t);if(!n)throw"HTML Element with id="+t+" not found";var r=window.innerWidth,i=document.createElement("div");function o(t,e){n.style.position="relative",i.style.position="absolute",i.style.top=t.toString()+"px",i.style.left=e.toString()+"px",i.style.background="rgba(0, 0, 0, 0.5)",n.appendChild(i)}if(i.id=e,r<600)o(0,0),i.style.width=n.style.width,i.style.height=n.style.height;else{var s=document.createElement("div");s.style.background="rgba(0, 0, 0, 0.5)",s.style.width=n.style.width,s.style.height="50px",n.appendChild(s)}},U=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function G(t,e,n){if(!t.videoConstraints)return n;if(t.videoConstraints.deviceId&&t.videoConstraints.deviceId.exact)for(var r=0;r<e.length;r++){var i=e[r];if(t.videoConstraints.deviceId.exact===i.deviceId)return[i]}}var N,V;function H(t){return{x:t[0].x,y:t[0].y}}!function(t){t[t.FILE=0]="FILE",t[t.URL=1]="URL"}(O||(O={})),function(t){t[t.AZTEC=0]="AZTEC",t[t.CODABAR=1]="CODABAR",t[t.CODE_39=2]="CODE_39",t[t.CODE_93=3]="CODE_93",t[t.CODE_128=4]="CODE_128",t[t.DATA_MATRIX=5]="DATA_MATRIX",t[t.EAN_8=6]="EAN_8",t[t.EAN_13=7]="EAN_13",t[t.ITF=8]="ITF",t[t.MAXICODE=9]="MAXICODE",t[t.PDF_417=10]="PDF_417",t[t.QR_CODE=11]="QR_CODE",t[t.RSS_14=12]="RSS_14",t[t.RSS_EXPANDED=13]="RSS_EXPANDED",t[t.UPC_A=14]="UPC_A",t[t.UPC_E=15]="UPC_E",t[t.UPC_EAN_EXTENSION=16]="UPC_EAN_EXTENSION"}(L||(L={})),function(t){t.BACK="environment",t.FRONT="user"}(P||(P={})),function(t){t.NONE="none",t.TORCH="torch",t.FLASH="flash"}(M||(M={})),function(t){t.CONTINUOUS="continuous",t.MANUAL="manual"}(k||(k={})),function(t){t[t.ERROR=0]="ERROR",t[t.WARNING=1]="WARNING",t[t.INFO=2]="INFO"}(D||(D={})),function(t){t.DEFAULT_WIDTH=300,t.DEFAULT_WIDTH_OR_HEIGHT=250,t.MAX_WIDTH_OR_HEIGHT_OFFSET=50,t.DEFAULT_ASPECT_RATIO=1}(x||(x={}));var j=function(t){var e,n,r;return t?(e=null!=(n=t.width)?n:x.DEFAULT_WIDTH_OR_HEIGHT,r=null!=(r=t.height)?r:e):e=r=x.DEFAULT_WIDTH_OR_HEIGHT,{width:e,height:r}},B={insertSvg:function(t,e,n){var r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("width",t.toString()),r.setAttribute("height",e.toString()),r.setAttribute("viewBox",n),t<e?r.setAttribute("style","height:100%;width:auto;"):r.setAttribute("style","height:auto;width:100%;"),r.innerHTML=e,document.getElementById("qr-shaded-region").appendChild(r)}},z=function(){function t(){}return t.isValid=function(e){return null!=e&&"number"==typeof e.downscaledWidth&&"number"==typeof e.downscaledHeight&&"number"==typeof e.x&&"number"==typeof e.y&&e.x>=0&&e.y>=0&&e.downscaledWidth>0&&e.downscaledHeight>0&&e.x+e.downscaledWidth<=e.width&&e.y+e.downscaledHeight<=e.height},t.isGreater=function(e,n){return!!z.isValid(e)&&(!!z.isValid(n)&&e.downscaledWidth*e.downscaledHeight>n.downscaledWidth*n.downscaledHeight)},t}(),W=(N=W||{})[N.NOT_STARTED=0]="NOT_STARTED",N[N.SCANNING=1]="SCANNING",N[N.PAUSED=2]="PAUSED",N[N.UNKNOWN=3]="UNKNOWN",(V=t.Html5QrcodeSupportedFormats||(t.Html5QrcodeSupportedFormats={}))[V.AZTEC=0]="AZTEC",V[V.CODABAR=1]="CODABAR",V[V.CODE_39=2]="CODE_39",V[V.CODE_93=3]="CODE_93",V[V.CODE_128=4]="CODE_128",V[V.DATA_MATRIX=5]="DATA_MATRIX",V[V.EAN_8=6]="EAN_8",V[V.EAN_13=7]="EAN_13",V[V.ITF=8]="ITF",V[V.MAXICODE=9]="MAXICODE",V[V.PDF_417=10]="PDF_417",V[V.QR_CODE=11]="QR_CODE",V[V.RSS_14=12]="RSS_14",V[V.RSS_EXPANDED=13]="RSS_EXPANDED",V[V.UPC_A=14]="UPC_A",V[V.UPC_E=15]="UPC_E",V[V.UPC_EAN_EXTENSION=16]="UPC_EAN_EXTENSION";var X=function(){function t(t,e){if(this.state=0,this.verbose=!1,this.elementId=t,this.verbose=!!e,this.checkRunning(),this.qrcode=null,this.shouldScan=!0,"string"!=typeof this.elementId)throw"elementId is not string";this.element=b(this.elementId)}return t.prototype.start=function(t,e,n,r){if(!t)throw"The camera id should be passed to start the QR scanner.";if(0!==this.state)throw new r("QR Reader is already running");this.checkRunning();var i,o="string"==typeof t?t:{deviceId:t};this.config=e;var s=A(this.config,_(o),T(o.facingMode));if(this.state=1,"function"==typeof n&&(this.qrCodeSuccessCallback=n),"function"==typeof r&&(this.qrCodeErrorCallback=r),!this.qrCodeSuccessCallback)throw"qrCodeSuccessCallback is required callback.";var a=this;return this.setScanning(!0),new Promise((function(t,n){var r,o,c,l,h;i=function(i,u){a.onMediaStreamReceived(i).then((function(){a.localMediaStream=u,t()})).catch((function(t){a.state=0,n(Q.create(t))}))},navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!1,video:s}).then((function(t){i(t.getTracks()[0].getCapabilities(),t)})).catch((function(t){var e;e="NotAllowedError"===t.name?u:"NotFoundError"===t.name?d:"NotReadableError"===t.name?p:"OverconstrainedError"===t.name?f:"StreamApiNotSupportedError"===t.name?m:s,n(Q.create({code:e.code,message:e.message+", error = "+t}))})):(r=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,o=window.webkitURL||window.URL,o&&r?((h=function(t){o.createObjectURL(t)}).toString=function(){return"function (){[native code]}"},l={},"string"==typeof s.facingMode?l.facingMode=s.facingMode:"object"==typeof s.facingMode&&(l.facingMode=s.facingMode.exact?{exact:s.facingMode.exact}:{ideal:s.facingMode.ideal}),(c=r.bind(navigator))({video:l,audio:!1},i,(function(t){n(Q.create({code:s.code,message:s.message+", error = "+t}))}))):n(Q.create(m)))}))}return t.prototype.stop=function(){var t=this;if(0!==this.state)return this.checkRunning(),this.state=0,this.setScanning(!1),this.clearElement(),new Promise((function(e,n){var r=t.localMediaStream.getTracks();r.forEach((function(t){t.stop()})),t.localMediaStream=void 0,e()}))},t.prototype.scanFile=function(t,e){var n=this;if(!t||!(t instanceof File))throw"file argument is mandatory and it should be instance of File.";var r=void 0===e||e;return new Promise((function(e,i){n.scanFileV2(t,r).then((function(t){e(t.decodedText)}),i)}))}return t.prototype.scanFileV2=function(t,e){var n=this;if(!t||!(t instanceof File))throw new r("file argument is mandatory and it should be instance of File.");return void 0===e&&(e=!0),new Promise((function(r,i){n.checkRunning();try{n.state=1;var o=function(t,e){var n=URL.createObjectURL(t);return new Promise((function(t,r){var i=new Image;i.onload=function(){var o=document.createElement("canvas");o.width=i.width,o.height=i.height;var s=o.getContext("2d");s.drawImage(i,0,0,i.width,i.height);var a=s.getImageData(0,0,i.width,i.height);t(n.decode(a))},i.onerror=r,i.src=e}))}(n.getZxingDecoder(),t).then((function(t){n.state=0,r(function(t){if(null==t)return null;var e,n,r=[];for(e=0;e<t.points.length;e++)n=t.points[e],r.push({x:n.x,y:n.y});return{decodedText:t.text,result:{format:{format:function(t){if(void 0===t||null===t)return R.UNKNOWN;switch(t){case L.AZTEC:return R.AZTEC;case L.CODABAR:return R.CODABAR;case L.CODE_39:return R.CODE_39;case L.CODE_93:return R.CODE_93;case L.CODE_128:return R.CODE_128;case L.DATA_MATRIX:return R.DATA_MATRIX;case L.EAN_8:return R.EAN_8;case L.EAN_13:return R.EAN_13;case L.ITF:return R.ITF;case L.MAXICODE:return R.MAXICODE;case L.PDF_417:return R.PDF_417;case L.QR_CODE:return R.QR_CODE;case L.RSS_14:return R.RSS_14;case L.RSS_EXPANDED:return R.RSS_EXPANDED;case L.UPC_A:return R.UPC_A;case L.UPC_E:return R.UPC_E;case L.UPC_EAN_EXTENSION:return R.UPC_EAN_EXTENSION;default:return R.UNKNOWN}}(t.format),formatName:L[t.format]},text:t.text,rawBytes:t.rawBytes,numBits:8*t.rawBytes.length,resultPoints:r,timestamp:Date.now()}}}(t))}),(function(){n.state=0,i(Q.create(o))})).catch((function(t){n.state=0,i(new r("Failed to scan file, error = "+t))}))}catch(t){n.state=0,i(Q.create(o))}}))}return t.prototype.clear=function(){this.checkRunning(),this.clearElement()},t.getCapabilities=function(){throw new i(Q.create(y))},t.prototype.pause=function(){2===this.state?this.verbose&&console.warn("Scanner is already paused"):0!==this.state&&2!==this.state?(this.state=2,this.setScanning(!1)):this.verbose&&console.warn("Cannot pause, scanner is not running.")},t.prototype.resume=function(){1===this.state?this.verbose&&console.warn("Scanner is already scanning"):0!==this.state&&1!==this.state?(this.state=1,this.setScanning(!0),this.scanContext&&this.scan(this.scanContext)):this.verbose&&console.warn("Cannot resume, scanner is not running.")},t.prototype.getState=function(){return this.state},t.prototype.getRunningTrackCapabilities=function(){if(!this.localMediaStream)throw new r("Kamera nie jest uruchomiona lub nie ma strumienia multimedialnego.");var e=this.localMediaStream.getTracks()[0].getCapabilities();return this.getRunningTrackSettings(),e},t.prototype.getRunningTrackSettings=function(){if(!this.localMediaStream)throw new r("Kamera nie jest uruchomiona lub nie ma strumienia multimedialnego.");return this.localMediaStream.getTracks()[0].getSettings()},t.prototype.applyVideoConstraints=function(t){if(!t)throw new r("videoConstaints is required argument.");if(!this.localMediaStream)throw new r("Kamera nie jest uruchomiona lub nie ma strumienia multimedialnego.");if(0===this.state)throw new r("Scanner is not running.");var e=this;return new Promise((function(n,i){var o,s;e.localMediaStream.getTracks()[0].applyConstraints(t).then((function(){n(e.onMediaStreamReceived(null))})).catch((function(t){i(t)}))}))},t.getScanRegion=function(t,e,n){var r={};return r.x=0,r.y=0,r.width=t,r.height=e,r.downscaledWidth=n.width,r.downscaledHeight=n.height,r.x=(t-r.downscaledWidth)/2,r.y=(e-r.downscaledHeight)/2,r},t.getCameras=function(){return new Promise((function(t,e){if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices&&navigator.mediaDevices.getUserMedia)navigator.mediaDevices.getUserMedia({audio:!1,video:!0}).then((function(n){n.getTracks().forEach((function(t){t.stop()})),navigator.mediaDevices.enumerateDevices().then((function(n){for(var r=[],i=0;i<n.length;i++){var o=n[i];"videoinput"==o.kind&&r.push({id:o.deviceId,label:o.label})}t(r)})).catch((function(t){e(Q.create({code:l.code,message:l.message+", error = "+t}))}))})).catch((function(n){var r;r="NotAllowedError"===n.name?u:g.message.toLocaleLowerCase()===n.message.toLocaleLowerCase()?g:h,e(Q.create({code:r.code,message:r.message+", error = "+n}))}));else{var i;i=navigator.mediaDevices?Q.create(h):Q.create(m),e(i)}}))},t.prototype.onMediaStreamReceived=function(t){var e=this;return new Promise((function(n,r){e.element.innerHTML="";try{var i,o,s,a=C(e.config);o=a.aspectRatio?a.aspectRatio:e.element.clientWidth/e.element.clientHeight,i=x.DEFAULT_ASPECT_RATIO*e.element.clientWidth,s=i/o,e.element.style.position="relative";var c=e.createVideoElement(i,s);e.videoElement=c,e.element.appendChild(c),a.disableFlip||(c.style.transform="scaleX(-1)"),e.qrcode?e.qrcode.setScanning(!0):e.setupQrCodeReader(a),e.qrcode.render(e.videoElement,e.localMediaStream),n()}catch(t){r("Gdy kamera jest uruchomiona, nie można jej ponownie uruchomić.")}}))},t.prototype.setScanning=function(t){this.shouldScan=t,this.qrcode&&this.qrcode.setScanning(t)},t.prototype.createVideoElement=function(t,e){var n=document.createElement("video");return n.style.width=t+"px",n.style.height=e+"px",n.autoplay=!0,n.playsInline=!0,n.muted=!0,n},t.prototype.clearElement=function(){if(0!==this.state){this.state=0;var t=document.getElementById(this.elementId);t&&(t.innerHTML=""),this.qrcode=null}},t.prototype.setupQrCodeReader=function(t){var e=this;if(this.config&&this.config.formatsToSupport){var n=this.config.formatsToSupport.map((function(t){return L[t]}));this.decoder=new zxing.MultiFormatReader(new Map([[zxing.DecodeHintType.POSSIBLE_FORMATS,n],[zxing.DecodeHintType.TRY_HARDER,zxing.DecodeHintType.TRY_HARDER]]))}else this.decoder=new zxing.MultiFormatReader(new Map([[zxing.DecodeHintType.POSSIBLE_FORMATS,[zxing.BarcodeFormat.QR_CODE]],[zxing.DecodeHintType.TRY_HARDER,zxing.DecodeHintType.TRY_HARDER]]));this.verbose&&this.decoder.setHints(new Map([[zxing.DecodeHintType.NEED_RESULT_POINT_CALLBACK,new zxing.ResultPointCallback(function(){})]]));var i=new I(t),o={frameGrabber:this.createFrameGrabber(i),onSuccessCallback:function(t,n){e.qrCodeSuccessCallback(t,n)},onErrorCallback:function(t){e.qrCodeErrorCallback(t,Q.create(o))}},s=function(t,n,i,o,s){var a=e.getShadedRegionBounds(i,o),c=zxing.FrameGrabber.createFrameGrabber(t,a,s,n);e.frameGrabber=c,e.frameGrabber.start()};this.frameGrabber?this.frameGrabber.start():this.config&&this.config.qrbox&&s(this.videoElement,this.element,this.element.clientWidth,this.element.clientHeight,i),this.scanRegion_?s(this.videoElement,this.element,this.element.clientWidth,this.element.clientHeight,i):this.verbose&&(console.log("No scan region defined, scanning whole video."),this.scanContext=o.frameGrabber.start())},t.prototype.checkRunning=function(){if(this.localMediaStream)throw new r("Cannot edit configuration while camera is running")},t.prototype.getZxingDecoder=function(){if(this.config&&this.config.formatsToSupport){var t=this.config.formatsToSupport.map((function(t){return L[t]}));this.decoder=new zxing.MultiFormatReader(new Map([[zxing.DecodeHintType.POSSIBLE_FORMATS,t],[zxing.DecodeHintType.TRY_HARDER,zxing.DecodeHintType.TRY_HARDER]]))}else this.decoder=new zxing.MultiFormatReader(new Map([[zxing.DecodeHintType.POSSIBLE_FORMATS,[zxing.BarcodeFormat.QR_CODE]],[zxing.DecodeHintType.TRY_HARDER,zxing.DecodeHintType.TRY_HARDER]]));return this.verbose&&this.decoder.setHints(new Map([[zxing.DecodeHintType.NEED_RESULT_POINT_CALLBACK,new zxing.ResultPointCallback(function(){})]])),this.decoder},t}();t.Html5Qrcode=X,t.Html5QrcodeScanner=function(){function t(e,n,r){var i=this;if(this.lastScanResult,this.html5Qrcode=null,this.verbose=!1,this.elementId=e,this.config=n,this.verbose=this.config?!!this.config.verbose:!1,this.qrCodeSuccessCallback=function(t,e){i.lastScanResult=e,i.sectionBody.style.display="none",i.sectionFoot.style.display="block",i.scanResultCallback(t)},this.qrCodeErrorCallback=r||function(t){},!document.getElementById(this.elementId))throw"HTML Element with id="+this.elementId+" not found"}return t.prototype.render=function(t,e){var n=this;this.qrCodeSuccessCallback=t,this.qrCodeErrorCallback=e||this.qrCodeErrorCallback,X.getCameras().then((function(t){n.renderWithCameras(t)})).catch((function(t){n.qrCodeErrorCallback(t.message)})).catch((function(t){n.qrCodeErrorCallback(t.message)}))},t.prototype.clear=function(){var t=this,e=function(){var e=document.getElementById("html5-qrcode-scanner-root"),n=document.getElementById("html5-qrcode-scanner-section-body");if(e.removeChild(n),(n=document.createElement("div")).id="html5-qrcode-scanner-section-body",e.appendChild(n),t.html5Qrcode&&t.html5Qrcode.clear(),document.getElementById("html5-qrcode-scanner-scan-result-close-button").removeEventListener("click",t.onScanResultCloseButtonClick),t.lastScanResult=void 0,t.html5Qrcode=null,t.cameraScanImage.style.display="block",t.fileScanImage.style.display="block",t.sectionFoot.style.display="none",t.qrCodeSuccessCallback=null,t.qrCodeErrorCallback=null}();this.html5Qrcode?this.html5Qrcode.stop().then((function(){e()})).catch((function(t){console.error("Failed to stop html5qrcode scanner, error="+t)})):e()},t.prototype.onScanResultCloseButtonClick=function(t){this.sectionFoot.style.display="none",this.sectionBody.style.display="block",this.html5Qrcode.resume()},t.prototype.scanResultCallback=function(t){var e,n,r;this.verbose&&console.log(t),e=this,document.getElementById("html5-qrcode-scanner-scan-result-text").innerText=t,"function"==typeof this.config.qrCodeSuccessCallback&&this.config.qrCodeSuccessCallback(t),n=document.getElementById("html5-qrcode-scanner-scan-result-image"),r=new Image,r.onload=function(){n.src=r.src},r.src="https://raw.githubusercontent.com/mebjas/html5-qrcode/master/assets/html5-qrcode-scan-success.svg"},t.prototype.createFileScanButton=function(){var t=document.createElement("input");return t.id="html5-qrcode-scanner-file-selection",t.type="file",t.accept="image/*",t.style.display="none",t},t.prototype.createCameraScanImage=function(){var t=document.createElement("img");return t.id="html5-qrcode-scanner-camera-scan-img",t.src="https://raw.githubusercontent.com/mebjas/html5-qrcode/master/assets/camera-scan.svg",t.style.width="40px",t.style.opacity=".5",t},t.prototype.createFileScanImage=function(){var t=document.createElement("img");return t.id="html5-qrcode-scanner-file-scan-img",t.src="https://raw.githubusercontent.com/mebjas/html5-qrcode/master/assets/file-scan.svg",t.style.width="40px",t.style.opacity=".5",t},t.prototype.createPermissionsDialog=function(){var t=this,e=document.createElement("div"),n=document.createElement("div");return n.innerText="Requesting camera permissions...",n.style.textAlign="center",n.style.fontWeight="bold",n.style.fontSize="large",n.style.color="rgb(102, 102, 102)",e.appendChild(n),e.appendChild(document.createElement("br")),e.appendChild(document.createElement("br")),e.appendChild(document.createElement("br")),e.appendChild(this.createCameraScanImage()),document.getElementById("html5-qrcode-scanner-section-body").appendChild(e),setTimeout((function(){e.style.display="none"}),2e3),t.sectionBody.appendChild(e),e},t.prototype.createScanner=function(t,e){if(this.html5Qrcode=new X(t,e),!this.config)throw"config not set";var n=this.config.qrbox?this.config.qrbox:250,r=document.createElement("div");r.style.width=n+"px",r.style.height=n+"px",r.style.border="1px solid silver",r.id="qr-shaded-region",document.getElementById(t).appendChild(r)},t.prototype.createSection=function(t,e,n){var r=this;return this.sectionBody=document.createElement("div"),this.sectionBody.id="html5-qrcode-scanner-section-body",this.sectionBody.style.position="relative",this.sectionBody.style.padding="10px",this.sectionBody.style.border="1px solid silver",this.sectionBody.style.borderRadius="5px",this.sectionFoot=document.createElement("div"),this.sectionFoot.id="html5-qrcode-scanner-section-foot",this.sectionFoot.style.textAlign="center",this.sectionFoot.style.display="none",this.cameraScanImage=this.createCameraScanImage(),this.fileScanImage=this.createFileScanImage(),this.sectionBody.appendChild(this.createPermissionsDialog()),this.sectionBody.appendChild(this.cameraScanImage),this.sectionBody.appendChild(this.fileScanImage);var i=document.createElement("span");i.innerText=" kamerą",this.cameraScanImage.appendChild(i);var o=document.createElement("span");o.innerText=" obrazem",this.fileScanImage.appendChild(o),document.getElementById("html5-qrcode-scanner-root").appendChild(this.sectionBody),document.getElementById("html5-qrcode-scanner-root").appendChild(this.sectionFoot);var s=document.getElementById("html5-qrcode-scanner-file-selection");this.fileScanImage.addEventListener("click",(function(){s.click()})),s.addEventListener("change",(function(e){if(1===e.target.files.length){var n=e.target.files[0];r.html5Qrcode.scanFile(n,!0).then(r.qrCodeSuccessCallback).catch(r.qrCodeErrorCallback)}})),this.sectionBody.addEventListener("dragenter",(function(t){t.stopPropagation(),t.preventDefault()}),!1),this.sectionBody.addEventListener("dragover",(function(t){t.stopPropagation(),t.preventDefault()}),!1),this.sectionBody.addEventListener("drop",(function(t){t.stopPropagation(),t.preventDefault();var e=t.dataTransfer.files;if(1===e.length)r.html5Qrcode.scanFile(e[0],!0).then(r.qrCodeSuccessCallback).catch(r.qrCodeErrorCallback)}),!1),e},t.prototype.renderWithCameras=function(t){var e=this,n=document.getElementById(this.elementId),r=document.createElement("div");r.id="html5-qrcode-scanner-root",n.appendChild(r);var i=this.createSection(t,this.config,"html5-qrcode-scanner-root"),o=this.createFileScanButton(),s=document.createElement("div");s.style.display="inline-block",s.style.width="80%",s.style.textAlign="center",s.appendChild(i),s.appendChild(o),document.getElementById("html5-qrcode-scanner-root").appendChild(s),this.createScanner("html5-qrcode-scanner-section-body",this.config),this.cameraScanImage.addEventListener("click",(function(){e.cameraScanImage.style.display="none",e.fileScanImage.style.display="none";var n,r=e.config?e.config.fps?e.config.fps:10:10,i=e.config?e.config.qrbox?e.config.qrbox:250:250;e.html5Qrcode.start(t[0].id,{fps:r,qrbox:i},e.qrCodeSuccessCallback,e.qrCodeErrorCallback).catch((function(t){e.qrCodeErrorCallback(t)}))}))},t.prototype.onScanResult=function(t){var e=document.createElement("div");e.innerText=t,e.id="html5-qrcode-scanner-scan-result-text",document.getElementById("html5-qrcode-scanner-section-foot").appendChild(e);var n=document.createElement("div");n.id="html5-qrcode-scanner-scan-result-image",document.getElementById("html5-qrcode-scanner-section-foot").appendChild(n);var r=document.createElement("button");r.innerText="Skanuj ponownie",r.id="html5-qrcode-scanner-scan-result-close-button",r.style.width="100px",r.style.height="auto",r.style.display="inline-block",r.addEventListener("click",this.onScanResultCloseButtonClick),document.getElementById("html5-qrcode-scanner-section-foot").appendChild(r)},t}();t.Html5QrcodeSupportedFormats=V,Object.defineProperty(t,"__esModule",{value:!0})}));
    </script>
    
    <script type="module">
        // Импорт модулей Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM-элементы ---
        const appContainer = document.getElementById('app-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const appTitle = document.getElementById('app-title');
        const appSubtitle = document.getElementById('app-subtitle');
        
        const visitorView = document.getElementById('visitor-view');
        const operatorView = document.getElementById('operator-view');
        const guardView = document.getElementById('guard-view');
        
        // Секция посетителя
        const ticketForm = document.getElementById('ticket-form');
        const purchaseBtn = document.getElementById('purchase-btn');
        const ticketFormSection = document.getElementById('ticket-form-section');
        const ticketDisplaySection = document.getElementById('ticket-display-section');
        const pendingPaymentSection = document.getElementById('pending-payment-section');
        const pendingTicketIdEl = document.getElementById('pending-ticket-id');
        const qrcodeContainer = document.getElementById('qrcode');
        const ticketNameEl = document.getElementById('ticket-name');
        const ticketDateEl = document.getElementById('ticket-date');
        const ticketStatusEl = document.getElementById('ticket-status');
        const newTicketBtn = document.getElementById('new-ticket-btn');

        // Секция оператора
        const pendingTabBtn = document.getElementById('pending-tab-btn');
        const statsTabBtn = document.getElementById('stats-tab-btn');
        const operatorPendingSection = document.getElementById('operator-pending-section');
        const operatorStatsSection = document.getElementById('operator-stats-section');
        const pendingList = document.getElementById('pending-list');
        const noPendingMsg = document.getElementById('no-pending-msg');
        const statsDateInput = document.getElementById('stats-date');
        const statsTotalCount = document.getElementById('stats-total-count');
        const statsVisitorList = document.getElementById('stats-visitor-list');
        const noVisitorsMsg = document.getElementById('no-visitors-msg');

        // Секция охранника
        const startScanBtn = document.getElementById('start-scan-btn');
        const qrReaderContainer = document.getElementById('qr-reader-container');
        const scanResultEl = document.getElementById('scan-result');

        // Общие элементы
        const toastEl = document.getElementById('toast');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Настройка Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'osho-tapoban-ticketing';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO_PROJECT" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId, ticketCollectionRef;
        let qrCodeGenerator = null;
        let html5QrCode = null;
        let currentTicketListener = null;
        let pendingPaymentsListener = null;

        // --- Инициализация приложения ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        setupApp();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                            showToast("Could not connect to the service.", 'error');
                            loadingSpinner.textContent = "Error loading app.";
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showToast("Application failed to load.", 'error');
                loadingSpinner.textContent = "Error loading app.";
            }
        }
        
        // --- Настройка приложения и роутинг ---
        function setupApp() {
            ticketCollectionRef = collection(db, `artifacts/${appId}/public/data/tickets`);
            setupEventListeners();
            handleRouting();
            
            loadingSpinner.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }
        
        function handleRouting() {
            const urlParams = new URLSearchParams(window.location.search);
            const role = urlParams.get('role');

            if (role === 'operator') {
                switchView('operator');
            } else if (role === 'guard') {
                switchView('guard');
            } else {
                switchView('visitor');
            }
        }
        
        // --- Логика переключения интерфейсов ---
        function switchView(view) {
            visitorView.classList.add('hidden');
            operatorView.classList.add('hidden');
            guardView.classList.add('hidden');

            if (pendingPaymentsListener) {
                pendingPaymentsListener();
                pendingPaymentsListener = null;
            }

            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanner:", err));
            }
            scanResultEl.innerHTML = '';
            qrReaderContainer.classList.add('hidden');
            startScanBtn.classList.remove('hidden');

            switch (view) {
                case 'visitor':
                    appTitle.textContent = "Osho Tapoban";
                    appSubtitle.textContent = "Digital Entry Pass";
                    visitorView.classList.remove('hidden');
                    break;
                case 'operator':
                    appTitle.textContent = "Operator Panel";
                    appSubtitle.textContent = "Управление";
                    operatorView.classList.remove('hidden');
                    showOperatorTab('pending');
                    break;
                case 'guard':
                    appTitle.textContent = "Guard Checkpoint";
                    appSubtitle.textContent = "Scan Visitor Tickets";
                    guardView.classList.remove('hidden');
                    break;
            }
        }

        // --- Вспомогательные функции ---
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function showToast(message, type = 'success', duration = 3000) {
            toastEl.textContent = message;
            toastEl.className = 'toast show';
            if (type === 'error') {
                 toastEl.style.backgroundColor = '#ef4444';
            } else if (type === 'info') {
                 toastEl.style.backgroundColor = '#3b82f6';
            } else {
                 toastEl.style.backgroundColor = '#22c55e';
            }
            setTimeout(() => { 
                toastEl.className = toastEl.className.replace('show', ''); 
            }, duration);
        }

        // --- Логика для посетителя ---
        async function handlePurchase(e) {
            e.preventDefault();
            purchaseBtn.disabled = true;
            purchaseBtn.textContent = 'Processing...';

            const name = ticketForm.name.value.trim();
            const phone = ticketForm.phone.value.trim();
            const today = getTodayDateString();

            if (!name || !phone) {
                showToast("Please fill in all fields.", 'error');
                purchaseBtn.disabled = false;
                purchaseBtn.textContent = 'Get Your Ticket';
                return;
            }

            try {
                const ticketData = {
                    visitorName: name,
                    visitorPhone: phone,
                    visitDate: today,
                    paymentMethod: 'cash',
                    status: 'pending_payment',
                    createdAt: serverTimestamp(),
                    createdBy: userId,
                };
                
                const docRef = await addDoc(ticketCollectionRef, ticketData);
                showPendingPaymentView(docRef.id);
                listenForTicketUpdates(docRef.id);

            } catch (error) {
                console.error("Error creating ticket:", error);
                showToast("Failed to create ticket. Please try again.", 'error');
            } finally {
                purchaseBtn.disabled = false;
                purchaseBtn.textContent = 'Get Your Ticket';
            }
        }
        
        function listenForTicketUpdates(ticketId) {
            if (currentTicketListener) {
                currentTicketListener();
            }
            const ticketDocRef = doc(db, `artifacts/${appId}/public/data/tickets`, ticketId);
            currentTicketListener = onSnapshot(ticketDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const ticket = docSnap.data();
                    if (ticket.status === 'paid' || ticket.status === 'used') {
                        showPaidTicketView(docSnap.id, ticket);
                        if (currentTicketListener) {
                            currentTicketListener(); 
                            currentTicketListener = null;
                        }
                    }
                }
            });
        }

        function showPendingPaymentView(ticketId) {
            ticketForm.reset();
            ticketFormSection.classList.add('hidden');
            ticketDisplaySection.classList.add('hidden');
            pendingPaymentSection.classList.remove('hidden');
            pendingTicketIdEl.textContent = ticketId.substring(0, 8) + '...';
        }

        function showPaidTicketView(ticketId, ticketData) {
            pendingPaymentSection.classList.add('hidden');
            ticketFormSection.classList.add('hidden');
            ticketDisplaySection.classList.remove('hidden');

            qrcodeContainer.innerHTML = "";
            if (!qrCodeGenerator) {
                qrCodeGenerator = new QRCode(qrcodeContainer, {
                    width: 200,
                    height: 200,
                    correctLevel : QRCode.CorrectLevel.H
                });
            }
            qrCodeGenerator.makeCode(ticketId);

            ticketNameEl.textContent = ticketData.visitorName;
            ticketDateEl.textContent = ticketData.visitDate;
            ticketStatusEl.textContent = ticketData.status.charAt(0).toUpperCase() + ticketData.status.slice(1);
            
            if (ticketData.status === 'used') {
                 ticketStatusEl.className = 'font-semibold text-red-500';
            } else {
                 ticketStatusEl.className = 'font-semibold text-green-600';
            }
        }
        
        function resetVisitorView() {
            if (currentTicketListener) {
                currentTicketListener();
                currentTicketListener = null;
            }
            ticketForm.reset();
            ticketFormSection.classList.remove('hidden');
            ticketDisplaySection.classList.add('hidden');
            pendingPaymentSection.classList.add('hidden');
        }

        // --- Логика для оператора ---
        function showOperatorTab(tabName) {
            if (tabName === 'pending') {
                operatorPendingSection.classList.remove('hidden');
                operatorStatsSection.classList.add('hidden');
                pendingTabBtn.classList.add('active');
                statsTabBtn.classList.remove('active');
                listenForPendingPayments();
            } else { // 'stats'
                operatorPendingSection.classList.add('hidden');
                operatorStatsSection.classList.remove('hidden');
                pendingTabBtn.classList.remove('active');
                statsTabBtn.classList.add('active');
                if (pendingPaymentsListener) {
                    pendingPaymentsListener();
                    pendingPaymentsListener = null;
                }
                const today = new Date().toISOString().split('T')[0];
                statsDateInput.value = today;
                fetchVisitorStats(today);
            }
        }

        function listenForPendingPayments() {
            if (pendingPaymentsListener) return;

            const today = getTodayDateString();
            const q = query(
                ticketCollectionRef, 
                where("status", "==", "pending_payment"),
                where("visitDate", "==", today)
            );

            pendingPaymentsListener = onSnapshot(q, (snapshot) => {
                pendingList.innerHTML = ''; 
                if (snapshot.empty) {
                    pendingList.appendChild(noPendingMsg);
                } else {
                    snapshot.docs.forEach(doc => {
                        const ticket = doc.data();
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                        card.innerHTML = `
                            <div>
                                <p class="font-semibold">${ticket.visitorName}</p>
                                <p class="text-sm text-gray-500">${ticket.visitorPhone}</p>
                                <p class="text-xs text-gray-400 font-mono mt-1">ID: ${doc.id.substring(0,8)}...</p>
                            </div>
                            <button data-id="${doc.id}" class="confirm-btn bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Confirm</button>
                        `;
                        pendingList.appendChild(card);
                    });
                }
            }, (error) => {
                console.error("Error listening to pending payments:", error);
                showToast("Could not load pending payments.", "error");
            });
        }
        
        async function handleConfirmPayment(e) {
            if (e.target.classList.contains('confirm-btn')) {
                const ticketId = e.target.dataset.id;
                e.target.disabled = true;
                e.target.textContent = '...';
                
                const ticketDocRef = doc(db, `artifacts/${appId}/public/data/tickets`, ticketId);
                try {
                    await updateDoc(ticketDocRef, {
                        status: "paid"
                    });
                    showToast("Payment confirmed successfully!");
                } catch (error) {
                    console.error("Error confirming payment:", error);
                    showToast("Failed to confirm payment.", 'error');
                    e.target.disabled = false;
                    e.target.textContent = 'Confirm';
                }
            }
        }
        
        async function fetchVisitorStats(dateString) {
            if (!dateString) return;
            statsVisitorList.innerHTML = `<p class="text-center text-gray-500">Загрузка...</p>`;
            statsTotalCount.textContent = '...';

            const q = query(
                ticketCollectionRef,
                where("visitDate", "==", dateString),
                where("status", "in", ["paid", "used"])
            );

            try {
                const querySnapshot = await getDocs(q);
                statsTotalCount.textContent = querySnapshot.size;
                statsVisitorList.innerHTML = ''; 

                if (querySnapshot.empty) {
                    statsVisitorList.appendChild(noVisitorsMsg);
                } else {
                    querySnapshot.forEach(doc => {
                        const ticket = doc.data();
                        const visitorCard = document.createElement('div');
                        visitorCard.className = 'bg-white p-3 rounded-lg shadow-sm flex justify-between items-center';
                        visitorCard.innerHTML = `
                            <div>
                                <p class="font-semibold">${ticket.visitorName}</p>
                                <p class="text-sm text-gray-500">${ticket.visitorPhone}</p>
                            </div>
                            <span class="text-sm font-medium rounded-full px-2 py-1 ${ticket.status === 'used' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${ticket.status === 'used' ? 'Посетил' : 'Оплачено'}</span>
                        `;
                        statsVisitorList.appendChild(visitorCard);
                    });
                }
            } catch (error) {
                console.error("Error fetching visitor stats:", error);
                showToast("Failed to load statistics.", 'error');
                statsVisitorList.innerHTML = `<p class="text-center text-red-500">Ошибка загрузки.</p>`;
            }
        }


        // --- Логика для охранника ---
        function startScanner() {
            if (!html5QrCode) {
                 html5QrCode = new Html5Qrcode("qr-reader");
            }

            scanResultEl.innerHTML = '';
            qrReaderContainer.classList.remove('hidden');
            startScanBtn.classList.add('hidden');

            const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                await html5QrCode.stop();
                qrReaderContainer.classList.add('hidden');
                startScanBtn.classList.remove('hidden');
                validateTicket(decodedText);
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => {
                    showToast("Could not start camera. Please grant permission.", "error");
                    qrReaderContainer.classList.add('hidden');
                    startScanBtn.classList.remove('hidden');
                });
        }
        
        async function validateTicket(ticketId) {
            const ticketDocRef = doc(db, `artifacts/${appId}/public/data/tickets`, ticketId);
            scanResultEl.innerHTML = `<p class="text-blue-500">Checking ticket...</p>`;
            try {
                const docSnap = await getDoc(ticketDocRef);
                if (!docSnap.exists()) {
                    displayScanResult('invalid', 'Ticket not found.');
                    return;
                }
                
                const ticket = docSnap.data();
                const today = getTodayDateString();

                if (ticket.visitDate !== today) {
                    displayScanResult('invalid', `Ticket is for ${ticket.visitDate}, not for today.`);
                    return;
                }

                if (ticket.status === 'paid') {
                    await updateDoc(ticketDocRef, { status: 'used' });
                    displayScanResult('success', `Welcome, ${ticket.visitorName}!`);
                } else if (ticket.status === 'used') {
                    displayScanResult('warning', `This ticket for ${ticket.visitorName} has already been used.`);
                } else if (ticket.status === 'pending_payment') {
                    displayScanResult('invalid', `Payment is still pending for this ticket.`);
                }
                
            } catch (error) {
                console.error("Error validating ticket:", error);
                displayScanResult('invalid', 'Error checking ticket. Please try again.');
            }
        }

        function displayScanResult(type, message) {
            let colorClass = '';
            let icon = '';
            switch (type) {
                case 'success':
                    colorClass = 'text-green-600 bg-green-100 border-green-300';
                    icon = '✓';
                    break;
                case 'warning':
                    colorClass = 'text-yellow-600 bg-yellow-100 border-yellow-300';
                    icon = '!';
                    break;
                case 'invalid':
                    colorClass = 'text-red-600 bg-red-100 border-red-300';
                    icon = '✖';
                    break;
            }
            scanResultEl.innerHTML = `<div class="p-4 rounded-lg border ${colorClass}"><p class="font-bold text-lg">${icon} ${message}</p></div>`;
        }

        // --- Установка обработчиков событий ---
        function setupEventListeners() {
            // Посетитель
            ticketForm.addEventListener('submit', handlePurchase);
            newTicketBtn.addEventListener('click', resetVisitorView);

            // Оператор
            pendingList.addEventListener('click', handleConfirmPayment);
            pendingTabBtn.addEventListener('click', () => showOperatorTab('pending'));
            statsTabBtn.addEventListener('click', () => showOperatorTab('stats'));
            statsDateInput.addEventListener('change', (e) => fetchVisitorStats(e.target.value));

            // Охранник
            startScanBtn.addEventListener('click', startScanner);
        }

        window.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
